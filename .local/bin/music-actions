#!/bin/sh
# Sync/download music using spotdl or yt-dlp

usage() { 
  printf "usage: ${0##*/} [-s [-n|-e]] [-d [-s|-y]] [-l]\n"
  exit 1
}

get_info() { 
  printf "$2 $1: "; read $1
  [ -z "$1" ] && exit 1
}

[ "$@" ] || usage
while getopts "s:d:lh" arg; do case "$arg" in
  s) 
    case "$OPTARG" in
      -n)
        get_info "url" "Playlist"; get_info "name" "Playlist"
        spotdl sync "$url" --save-file "$name.sync.spotdl" --m3u "$name.m3u8"
        ;;

      -e)
        name=$(printf '%s\n' *.spotdl | fzf --prompt "Select a playlist: ")
        printf "You selected: $name\n"
        spotdl sync "$name.sync.spotdl" --m3u "$name.m3u8"
        ;;

      ?|*) printf "usage: ${0##*/} -$arg [-n] [-e]\n"; exit 1 ;;
    esac
    ;;

  d)
    get_info "url" "Song/playlist"
    case "$OPTARG" in
      -s) spotdl download "$url" ;;
      -y) yt-dlp -x -f 'bestaudio[acodec=opus]' --audio-format 'opus' \
        --audio-quality '0' "$url" ;;
      ?|*) printf "usage: ${0##*/} -$arg [-s] [-y]\n"; exit 1 ;;
    esac
    ;;
  
  l)
    command -v syncedlyrics >/dev/null || exit 1
    for f in *.opus *.mp3 *.flac *.m4a *.wav *.aac; do
      [ -f "$f" ] || continue
      name="${f%.*}"
      syncedlyrics "$name" > "$name.lrc" && \
        printf "Lyrics for $f written to $name.lrc\n"
    done
    ;;
  
  ?|*) usage ;;
esac; done
